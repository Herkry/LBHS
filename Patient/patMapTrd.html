<!DOCTYPE html>
<html lang="en">
<head>
  <title>Dashboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <style type="text/css">
        body{ font: 14px sans-serif; }
        
		
		.wrapper{ width: 350px; padding: 20px; 
		margin: auto;
		
		border-radius: 25px;
		
		background-color: white;
	
		}
        #constant{
      background-color: white;
      height: 100%;
      padding: 0%;
	  }
	  #sublabel13{
	width:200px;
	height:20px;
	border:1px solid;
	margin: 10px;
	float: right;
	
	margin-left: 100px;
	padding-top:1px;
	text-align: center;
	color: #626567;
	font-family: "Angsana New", Angsana, serif;
    font-size:20px;
	border-radius: 25px;
}
    .navbar {
    
      background-image:linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url(myArt.jpg);
      font-family: "Angsana New", Angsana, serif;
      font-size:20px;

    }

		#back{
		
	
			padding-top: 0px;
			
		}
		
		#label3{
      height:550px;
      padding-top: 30px;
    
	  margin-top:20px;
  
      }
  
   #sublabel31{
	    width:800px;
	    height:170px;
      float: bottom;
	    margin:auto;
      padding-top: 20px;
	    font-size:30px;
	    font-family: "Angsana New", Angsana, serif;
	    color: white;
	    text-align:left;
	    padding:30px;
	
	    background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6));
		border-radius: 25px;
      }
   #sublabel32{
     width:600px;
	   height:150px;
  
	   margin:auto;
	   margin-top: 30px;
     font-family:"Angsana New", Angsana, serif;
     font-size:25px;
     text-align: left;
    
     padding:30px;
     color:white;
     background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6));
	 border-radius: 25px;
     }

#sublabel33{
     width:250px;
     height:50px;
     margin: auto;
     margin-top: 30px;
     padding-top:11px;
     text-align: center;
     font-family: "Angsana New", Angsana, serif;
     font-size:20px;
     border-radius: 25px;
     background-color: #CB4335;
	 border-radius: 25px;
    
}



        #map{
            height:500px;
            width:100%;
			padding:0px;
        }
		#search{
          width:200px;
        
		  display:inline;
		  padding-left:0px;
		  
		  
		  
		  
		}
		#specialist{
			float: left;
			margin-right:50px;
			padding-top:10px;
			width:200px;
		
		}
		#radius{
			float: left;
			padding-top:10px;
			width:200px;
			margin-right:50px;

		}
		#buttons{
			float:left;
			padding-top:30px;
			width:200px;
		}

		footer {
	  background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6));
      padding: 25px;
	  height: 200px;
    }




	
    </style>
</head>
<body>  			
			
<div id="constant">
  <div id="label1" style="color: #CB4335; font-family: Angsana New, Angsana, serif; font-size:25px;">
      <img src="logo.png" height="70" width="70"/>
	  Geolocation Based Healthcare
	  <div id="sublabel13">
		  <img src= "profile.png" height="20" width="20" />
		  <?php echo htmlspecialchars($_SESSION["username"]); ?>
	  </div>
  </div>

</div>
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>                        
      </button>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li class="active" ><a href="#" style="color: white;">Home</a></li>
        <li><a href="dash1.php" style="color: white;">Appointments</a></li>
        <li><a href="emergency1.php"style="color: white;">Emergency</a></li>
		<li><a href="prescription.php"style="color: white;">Prescription</a></li>
		<li><a href="history.php"style="color: white;">Medical History</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
		<li><a href="reset-password.php" style="color: white;">Reset Your Password</a></li>
        <li ><a href="logout.php" style="color: white;"><span class="glyphicon glyphicon-log-in"></span> Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

		   <div id="search">

		   <div id="specialist" class="form-group">
                <label>Search Specialist</label>
				<input type="text" id="zoom-to-area-text" class="form-control">
				
		   </div>
		   
		   <div id="radius" class="form-group">
                <label>Radius</label>
				<input type="text" name="search" class="form-control">
		   </div>
		   <div id="buttons">
		   <input id="show-listings" type="button" class="btn btn-primary" value="Show Listings">

		  </div>
		  
		  <div id="buttons">
		
		   <input id="hide-listings" type="button" class="btn btn-primary" value="Hide Listings">

      </div>
      
		  

		  
		  <div id="buttons">

           <input id="zoom-to-area" class="btn btn-primary" type="button" value="Zoom">
          </div>
		   
	       </div>

		   <div id="map">
		   <script>
      /*var customLabel = {
        restaurant: {
          label: 'R'
        },
        bar: {
          label: 'B'
        }
      };
	  */
		//Creating map
		//var map;
		
		//Create a new blank array for all the listing markers and also create marker and position of user variables, also creating map variable here
        var markersAll = [];
        var markerUser;
        var pos;
        var map;
		
		//Create a new blank array for all the locations and their details.
		var locationsAll = [];
		
    function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
			center: new google.maps.LatLng(-33.863276, 151.207977),
			zoom: 12
      });
      var infoWindow = new google.maps.InfoWindow;
		
		
		  //Finding user location
		  var infoWindowUser = new google.maps.InfoWindow;

      // Try HTML5 geolocation.
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
          };
			
			markerUser = new google.maps.Marker({
			    position: pos,
			    map: map,
			    title: 'Your Position'
            });
            

          //infoWindowUser.setPosition(pos);
          //infoWindowUser.setContent('Location found.');
          //infoWindowUser.open(map);
          map.setCenter(pos);
        
			    markerUser.addListener('click', function() {
			      if (infoWindow.marker != marker) {
                    infoWindowUser.setContent(markerUser.title);
                    infoWindow.open(map, marker);
				
				      // Make sure the marker property is cleared if the infowindow is closed.
				      infoWindow.addListener('closeclick', function() {
				      infoWindow.marker = null;
				      });
			      }
          });
			
        }, function() {
            handleLocationError(true, infoWindowUser, map.getCenter());
            });

        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindowUser, map.getCenter());
        }
      

        function handleLocationError(browserHasGeolocation, infoWindowUser, pos) {
          infoWindowUser.setPosition(pos);
          infoWindowUser.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
          infoWindowUser.open(map);
        }	


			
		//Incremental Here to track no. of entries/markers
        var i = 0;
        
		
		//Change this depending on the name of your PHP or XML file
        downloadUrl('MyXmlFile4.xml', function(data) {
            var xml = data.responseXML;
            var markers = xml.documentElement.getElementsByTagName('marker');
            Array.prototype.forEach.call(markers, function(markerElem) {
                var docFname = markerElem.getAttribute('docFname');
                var docLname = markerElem.getAttribute('docLname');
                var docPhone = markerElem.getAttribute('docPhone');
                var docSpecialty = markerElem.getAttribute('docSpecialty');  
                var hospId = markerElem.getAttribute('hospId');
                var hospName = markerElem.getAttribute('hospName');
                var hospAddress = markerElem.getAttribute('hospAddress');
                var point = new google.maps.LatLng(
                  parseFloat(markerElem.getAttribute('hospLat')),
                  parseFloat(markerElem.getAttribute('hospLong')));				  
				    /* 
				    var position = point;
				    var title = hospName;
				    // Create a marker per location, and put into markers array.
				    var marker = new google.maps.Marker({
					    map: map,
					    position: position,
					    title: title,
					    animation: google.maps.Animation.DROP,
					    id: i
				    });
				    // Push the marker to our array of markers.
				    markers.push(marker);
				    */ 
				  

			        //InfoWindow Content
              
                    var contentAll = "<b>Dr. "+docFname+"</b><br>"+docSpecialty+"<br>"+docPhone+"<br>"+hospName+"<br><br><form action = 'saveMapDocInfoPr.php' method = 'post'><input type = 'submit' name = 'submit' value = 'See Dr. " +docFname+"'/> </form>";


                    var infowincontent = document.createElement('div');
                    var strong = document.createElement('strong');
                    strong.textContent = "Dr. "+docFname;
                    infowincontent.appendChild(strong);

                    infowincontent.appendChild(document.createElement('br'));
                    var text = document.createElement('text');
                    text.textContent = docSpecialty ;
                    infowincontent.appendChild(text);

                    infowincontent.appendChild(document.createElement('br'));
                    var text = document.createElement('text');
                    text.textContent = docPhone;
                    infowincontent.appendChild(text);

                    infowincontent.appendChild(document.createElement('br'));
                    var text = document.createElement('text');
                    text.textContent = hospName;
                    infowincontent.appendChild(text);

                    
                    // icon = customLabel[type] || {};
			  
                    var marker = new google.maps.Marker({
                        map: map,
                        position: point,
                        title: docSpecialty
                        //label: icon.label
                    });

                    //Calling showlistings and hidelistings functions
                    document.getElementById('show-listings').addEventListener('click', showListings);
                    document.getElementById('hide-listings').addEventListener('click', hideListings);
                    //document.getElementById('appointment').addEventListener('click', appointmentDataInsertDB);

                    // Push the marker to our array of markers.
                    markersAll.push(marker);

              
              
              marker.addListener('click', function() {
			            if (infoWindow.marker != marker) {
                        infoWindow.setContent(contentAll);
                        infoWindow.open(map, marker);
				
				                 // Make sure the marker property is cleared if the infowindow is closed.
				                infoWindow.addListener('closeclick', function() {
				                  infoWindow.marker = null;
				                });
			            }
              });
              
			
			
			        
              marker.setMap(map);

            }); //foreach loop
          }); //downloadUrl function
        } //initMap
        
        //Distance Function
        //searchWithinTime();
        
//Inserting into DB appointmentData------------------------------------------------------------------------------------------------
//function appointmentDataInsertDB(){
//        var xmlhttp = new XMLHttpRequest();
//        xmlhttp.onreadystatechange = function() {
//          if (this.readyState == 4 && this.status == 200) {
//            //document.getElementById("txtHint").innerHTML = this.responseText;
//          }
//        }
//        var str = 45;
//        xmlhttp.open("GET", "ajax.php?q="+str, true);
//        xmlhttp.send();
//}
//Inserting into DB appointmentData------------------------------------------------------------------------------------------------




//Showing and Hiding Listings----------------------------------------------------------------------------------------------------------
    function showListings() {
        //var bounds = new google.maps.LatLngBounds();
        // Extend the boundaries of the map for each marker and display the marker
        for (var i = 0; i < markersAll.length; i++) {
            var specialty = document.getElementById('zoom-to-area-text').value;
            if(specialty == markersAll[i].title){
                markersAll[i].setMap(map);
            }
            
          //bounds.extend(markersAll[i].position);
        }
        //map.fitBounds(bounds);
        //searchWithinTime();
      }

      // This function will loop through the listings and hide them all.
      function hideListings() {
        for (var i = 0; i < markersAll.length; i++) {
            markersAll[i].setMap(null);
        }
      }
//Showing and Hiding Listings----------------------------------------------------------------------------------------------------------
      

        //Insert into DB TEST
        //var xmlhttp = new XMLHttpRequest();
        //xmlhttp.onreadystatechange = function() {
        //    if (this.readyState == 4 && this.status == 200) {
        //        //document.getElementById("txtHint").innerHTML = this.responseText;
        //    }
       // }
        //var str = 45;
        //xmlhttp.open("GET", "ajax.php?q="+str, true);
        //xmlhttp.send();



//Finding Distances-------------------------------------------------------------------------------------------------------------------
function searchWithinTime() {
        // Initialize the distance matrix service.
        var distanceMatrixService = new google.maps.DistanceMatrixService;
  //CHANGE1-Address is user location
        var address = markerUser.position;
        // Check to make sure the place entered isn't blank.
        if (address == '') {
          window.alert('You must enter an address.');
        } else {
            //window.alert('You must enter an addresssssssssss');
          //hideListings();
          window.alert('You must enter an addresssssssssss');
          // Use the distance matrix service to calculate the duration of the
          // routes between all our markers, and the destination address entered
          // by the user. Then put all the origins into an origin matrix.
          var origins = [];
          for (var i = 0; i < markersAll.length; i++) {
            origins[i] = markersAll[i].position;
          }
          var destination = address;
  //CHANGE2-Comment line below
          //var mode = document.getElementById('mode').value;
          // Now that both the origins and destination are defined, get all the
          // info for the distances between them.
          distanceMatrixService.getDistanceMatrix({
            origins: origins,
            destinations: [destination],
  //CHANGE3- Comment Line below
            //travelMode: google.maps.TravelMode[mode],
            unitSystem: google.maps.UnitSystem.IMPERIAL,
          }, function(response, status) {
            if (status !== google.maps.DistanceMatrixStatus.OK) {
              window.alert('Error was: ' + status);
            } else {
              displayMarkersWithinTime(response);
            }
          });
        }
      }//searchWithinTime


      // This function will go through each of the results, and,
      // if the distance is LESS than the value in the picker, show it on the map.
      function displayMarkersWithinTime(response) {
        //var maxDuration = document.getElementById('max-duration').value;
        var origins = response.originAddresses;
        var destinations = response.destinationAddresses;
        // Parse through the results, and get the distance and duration of each.
        // Because there might be  multiple origins and destinations we have a nested loop
        // Then, make sure at least 1 result was found.
        var atLeastOne = false;
        for (var i = 0; i < origins.length; i++) {
          var results = response.rows[i].elements;
          for (var j = 0; j < results.length; j++) {
            var element = results[j];
            if (element.status === "OK") {
                // The distance is returned in feet, but the TEXT is in miles. If we wanted to switch
                // the function to show markers within a user-entered DISTANCE, we would need the
                // value for distance, but for now we only need the text.
                var distanceText = element.distance.text;
                // Duration value is given in seconds so we make it MINUTES. We need both the value
                // and the text.
                var duration = element.duration.value / 60;
                var durationText = element.duration.text;
                //if (duration <= maxDuration) {
                //the origin [i] should = the markers[i]
                markersAll[i].setMap(map);
                 atLeastOne = true;
                // Create a mini infowindow to open immediately and contain the
                // distance and duration
                var infowindow = new google.maps.InfoWindow({
                  content: durationText + ' away, ' + distanceText
                });
                infowindow.open(map, markersAll[i]);
                // Put this in so that this small window closes if the user clicks
                // the marker, when the big infowindow opens
                markersAll[i].infowindow = infowindow;
                google.maps.event.addListener(markersAll[i], 'click', function() {
                   this.infowindow.close();
                });
              //}
                }
              }
             }
              if (!atLeastOne) {
                window.alert('We could not find any locations within that distance!');
              }
            }//displayMarkersWithinTime
        
            //Finding Distances-------------------------------------------------------------------------------------------------------------------




            //Finding Directions-------------------------------------------------------------------------------------------------------------------
            function displayDirections(origin) {
                var directionsService = new google.maps.DirectionsService;
                // Get the destination address from the user entered value.
                var destinationAddress = destination;
                directionsService.route({
                    // The origin is the passed in marker's position.
                    origin: origin,
                    // The destination is user entered address.
                    destination: destinationAddress,
          
                }, function(response, status) {
                        if (status === google.maps.DirectionsStatus.OK) {
                            var directionsDisplay = new google.maps.DirectionsRenderer({
                                map: map,
                                directions: response,
                                draggable: true,
                                polylineOptions: {
                                strokeColor: 'green'
                            }
                        });
                        } else {
                            window.alert('Directions request failed due to ' + status);
                        }
                });
            }
                
   
        
          //Finding Directions--------------------------------------------------------------------------------------------



          //DouwnloadURL Function--------------------------------------------------------------------------------------------
          function downloadUrl(url, callback) {
            var request = window.ActiveXObject ?
                new ActiveXObject('Microsoft.XMLHTTP') :
                new XMLHttpRequest;

            request.onreadystatechange = function() {
              if (request.readyState == 4) {
                request.onreadystatechange = doNothing;
                callback(request, request.status);
              }
            };

            request.open('GET', url, true);
            request.send(null);
        }
          //DouwnloadURL Function-------------------------------------------------------------------------------      
      



          //-----------------------------------------------------------------------------------------------------------
	        //Functions YET to be used
	        // This function populates the infowindow when the marker is clicked. We'll only allow
          // one infowindow which will open at the marker that is clicked, and populate based
          // on that markers position.
	        function populateInfoWindow(marker, infowindow) {
            // Check to make sure the infowindow is not already opened on this marker.
            if (infowindow.marker != marker) {
              infowindow.marker = marker;
              infowindow.setContent('<div>' + "Harry" + '</div>');
              infowindow.open(map, marker);
              // Make sure the marker property is cleared if the infowindow is closed.
              infowindow.addListener('closeclick', function() {
                infowindow.marker = null;
              });
            }
          }

          function doNothing() {}
          //-------------------------------------------------------------------------------------------------

        </script>
    
        <script async defer
          src="https://maps.googleapis.com/maps/api/js?libraries=geometry,drawing&key=AIzaSyCX_XcVwDhTZdtx8-mkuitLN48uuBT_FE4&v=3&callback=initMap">
        </script>
      </div>
    </body>
  </html>